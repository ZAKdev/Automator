<!-- meta redirect to service page on subscription error  !-->
<ejs>
    var redirectToLandingPageOnSubscriptionError = true;
    if (redirectToLandingPageOnSubscriptionError && typeof error != "undefined") {
</ejs>

        <ejs> if (typeof landingPageUrl == "undefined" || landingPageUrl.trim() == "") { </ejs>
                <body>
                    fallback url missing (add params.fallbackUrl to tag)
                </body>
        <ejs> } else { </ejs>
                <html>
                    <head>
                        <meta http-equiv="refresh" content="0;URL='<ejs>= landingPageUrl </ejs>'"/>
                    </head>
                </html>
        <ejs>} </ejs>

<ejs>
    } else {
</ejs>

    <html>
        
        <head>
            <script type="text/javascript" src="/public/url-parser.js"></script>
            <script type="text/javascript" src="/public/livescript/prelude.js"></script>
            <script type="text/javascript" src="/public/livescript/utils.js"></script>
                
            <script type="text/javascript">

                var redirectToServicePageAutomatically = true, 
                    serviceUrl,
                    subscriptionCheckUrl;

                // subscriptionCheckUrl is present if there was no error during try-subscribe action
                <ejs>
                    if (typeof subscriptionCheckUrl != "undefined") {
                </ejs>
                        subscriptionCheckUrl = "<ejs>= subscriptionCheckUrl </ejs>";
                <ejs>
                    }
                </ejs>
                
                // service url is present if the user is AlreadySubscribed
                <ejs>
                    if (typeof serviceUrl != "undefined") {
                </ejs>
                        serviceUrl = "<ejs>= serviceUrl </ejs>";
                <ejs>
                    }
                </ejs>

                // pollSubscriptionCheckUrl :: String -> Int -> Int -> (String -> Void) -> (Error -> Void)
                function pollSubscriptionCheckUrl(subscriptionCheckUrl, maxRetries, delay, successCallback, errorCallback) {
                    if (maxRetries < 0)
                        errorCallback();
                    else 
                        utils.getJSONP(subscriptionCheckUrl, function(response){
                            if (!!response.redirectUrl)
                                successCallback(response.redirectUrl);
                            else
                                setTimeout(function(){
                                    pollSubscriptionCheckUrl(subscriptionCheckUrl, maxRetries - 1, delay, successCallback, errorCallback);
                                }, delay);
                        });
                };

                // processServiceUrl :: String -> Void
                function processServiceUrl(serviceUrl) {

                    // redirect automatically
                    if (redirectToServicePageAutomatically)
                        window.location.href = serviceUrl;

                    // redirect on click
                    else {
                        servicePageButton = document.getElementById("service-page-button");
                        // servicePageButton.innerHTML = serviceUrl
                        servicePageButton.style.display = "block";
                        servicePageButton.href = serviceUrl

                        unsubscribe = document.getElementById("unsubscribe");
                        unsubscribe.href = serviceUrl.replace("http://m.mobileacademy.com", "http://start.mobileacademy.com/SubscriptionInfo.aspx")
                    }

                }

                window.addEventListener("load", function(){

                    if (!!serviceUrl)
                        processServiceUrl(serviceUrl);

                    else if (!!subscriptionCheckUrl) {

                        var pollingError = document.getElementById("polling-error"),
                            congrats = document.getElementById("congrats");

                        pollSubscriptionCheckUrl(subscriptionCheckUrl, 10, 2000, function(serviceUrl){
                            processServiceUrl(serviceUrl);
                        }, function() {
                            pollingError.style.display = "block";
                            congrats.style.display = "none";
                        });

                    }

                });

            </script>
        </head>

        <body>

            <div id="polling-error" style="display:none">polling error</div>
            <div id="congrats" style="display:none">congrats</div>

        </body>

    </html>

<ejs>
    }
</ejs>